# This is a base compose file that contains configuration 
# that will not change across different deployment types and environments
# There will be additional compose files that extend it and add custom configuration


# Docker Compose assigns project names automatically based on the parent directory.
# This project name becomes a prefix for all project components (images, volumes, networks).
# Example: In a project directory called "deployment_docs", a volume named "test_volume" becomes "deployment_docs-test_volume"
# Consider setting an explicit project name to better track your project's components.
name: deployment_docs

services:
  # the container names are appended with word _test
  # so they do not conflict with the deployed containers during deployment.
  # if the test container passes tests, its suffix will be removed 
  solarpred:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: solarpred
    environment:
      # you can add env vars and secrets here.
      # HOWEVER you should know that managing secrets this way is not secure
      # since they will be stored in _plain text_ in container configuration file. 
      - COMMIT_ID=${COMMID_ID}
      - PORT=${PORT}
      - IS_DEV=0
    
    volumes:
      # if you save a file inside /app/data in the container,
      # it will also be in test_volume container.
      # when the same volume is mounted on several containers,
      # its contents can be accessed by all of those containers. 
      - solar_data:/app/data

    expose:
      - ${PORT}
    ports:
      # Port Mapping format: outside_port:internal_port
      - "${PORT}:${PORT}"

    networks:
      - local_network
    
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${PORT}/healthcheck"]
      interval: 10s
      timeout: 3m
      retries: 18
      start_period: 30s

volumes:
  solar_data:

networks:
  # Local network enables communication only between containers
  # within this specific compose project
  # Example: From container 'test_tollbal_test': curl http://extra:internal_port/healthcheck
  local_network:
    driver: bridge